<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <!-- ë·°í¬íŠ¸ ì„¤ì •: env(safe-area-inset-*) ì‚¬ìš©ì„ ìœ„í•´ viewport-fit=cover í•„ìš” -->
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Chat UI (Messages Only)</title>
  <style>
    html, body {
       overflow-x: hidden; /* ì¢Œìš° ìŠ¤í¬ë¡¤ ì œê±° */
    }
    body {
      margin: 0;
      padding: 0;
      background: #f5f5f5;
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Helvetica, Arial, sans-serif;
    }
    /* Safe Areaë¥¼ ê³ ë ¤í•œ ì»¨í…Œì´ë„ˆ */
    .chat-container {
      padding-top: calc(env(safe-area-inset-top, 0px) + 10px);
      padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 10px);
      box-sizing: border-box;
      height: 100vh;
      overflow: hidden;
    }
    /* ë©”ì‹œì§€ ì˜ì—­ì— ì¶”ê°€ ì—¬ë°±ì„ ì¤˜ì„œ ë§ˆì§€ë§‰ ë©”ì‹œì§€ê°€ ì…ë ¥ ì˜ì—­ ìœ„ì— ë‚˜íƒ€ë‚˜ë„ë¡ í•¨ */
    .chat-messages {
      padding: 10px;
      /* ê¸°ì¡´ ì—¬ë°± 10px + ì¶”ê°€ ì—¬ë°±(ì˜ˆ: 100px, ì…ë ¥ ì˜ì—­ ë†’ì´ì— ë§ì¶° ì¡°ì •) */
      padding-bottom: calc(10px + env(safe-area-inset-bottom, 0px) + 50px);
      overflow-y: auto;
      overflow-x: hidden; /* ì¢Œìš° ìŠ¤í¬ë¡¤ ì œê±° */
      height: 100%;
      box-sizing: border-box;
    }
    .chat-message {
      margin: 5px 0;
    }
    .chat-bubble {
      display: inline-block;
      padding: 10px;
      border-radius: 10px;
      max-width: 90%;
      word-wrap: break-word;
      word-break: break-all;       /* ê¸´ ë‹¨ì–´ë„ ì¤„ë°”ê¿ˆ */
      background: #ddd;
      font-size: 14px;
      text-align: left; /* ğŸ‘ˆ ì™¼ìª½ ì •ë ¬ ê°•ì œ ì ìš© */
    }
    .chat-message.sent {
      text-align: right;
    }
    .chat-message.sent .chat-bubble {
      background: #0084FF; /* ë³´ë‚¸ ë©”ì‹œì§€ëŠ” íŒŒë€ìƒ‰ */
      color: white;
      text-align: left; /* ğŸ‘ˆ ë‚´ë¶€ í…ìŠ¤íŠ¸ëŠ” ì™¼ìª½ ì •ë ¬ ìœ ì§€ */
      display: inline-block;
    }
      
    /* ìˆ˜ì‹  ë©”ì‹œì§€ (ì™¼ìª½ ì •ë ¬, ë°ì€ íšŒìƒ‰ ë°°ê²½) */
    .chat-message.received {
      text-align: left;
    }
    .chat-message.received .chat-bubble {
      background: #e5e5ea;
      color: black;
      text-align: left;
    }
  </style>
  <!-- mathpix-markdown-it ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ (ìˆ˜ì‹ ë° Markdown ë Œë”ë§) -->
  <script src="https://cdn.jsdelivr.net/npm/mathpix-markdown-it@2.0.6/es5/bundle.js"></script>
  <!-- lottie-web ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
  <script>
      (function() {
        // console.log ì¶œë ¥ì„ Swiftë¡œ ì „ë‹¬
        var oldLog = console.log;
        console.log = function(message) {
          oldLog.apply(console, arguments);
          if (window.webkit && window.webkit.messageHandlers.consoleLog) {
            window.webkit.messageHandlers.consoleLog.postMessage(message);
          }
        };
        console.log("JavaScript Loaded Successfully.");
      })();
      
      var typingAnimation; // ì „ì—­ ë³€ìˆ˜ì— í• ë‹¹í•´ì„œ ì œì–´í•  ìˆ˜ ìˆìŒ
      // DOMContentLoaded ì´í›„ì— Lottie ì• ë‹ˆë©”ì´ì…˜ì„ ë¡œë“œ
      document.addEventListener("DOMContentLoaded", function() {
        typingAnimation = lottie.loadAnimation({
          container: document.getElementById('lottie-animation'), // ì• ë‹ˆë©”ì´ì…˜ì´ í‘œì‹œë  ì»¨í…Œì´ë„ˆ
          renderer: 'svg',      // svg ë Œë”ëŸ¬ ì‚¬ìš©
          loop: true,           // ë¬´í•œ ë°˜ë³µ
          autoplay: true,       // ìë™ ì¬ìƒ
          path: 'typing.json'   // typing.json íŒŒì¼ ê²½ë¡œ (ëŒ€ì†Œë¬¸ì ë° ê²½ë¡œ í™•ì¸)
        });
        
        typingAnimation.play()
        console.log("typingAnimation....."+typingAnimation);
      });
      
      // íƒ€ì´í•‘ ì• ë‹ˆë©”ì´ì…˜ì„ ë³´ì´ê²Œ í•˜ëŠ” í•¨ìˆ˜
      function showTypingAnimation() {
        console.log("showTypingAnimation.....");
        var container = document.getElementById("lottie-animation");
        if (container) {
          console.log("container....."+container);
          console.log("typingAnimation....."+typingAnimation);

          container.style.display = "block";
          if (typingAnimation) {
            typingAnimation.play();
            
            console.log("showTypingAnimation...play()");
          }
        }
      }

      // íƒ€ì´í•‘ ì• ë‹ˆë©”ì´ì…˜ì„ ìˆ¨ê¸°ëŠ” í•¨ìˆ˜
      function hideTypingAnimation() {
        console.log("hideTypingAnimation.....");
        var container = document.getElementById("lottie-animation");
        if (container) {
          container.style.display = "none";
          if (typingAnimation) {
            typingAnimation.stop();
          }
        }
      }
      
      function addMessage(text, type) {
        var container = document.getElementById("chatMessages");
        var messageDiv = document.createElement("div");
        messageDiv.className = "chat-message " + type;
        
        var bubble = document.createElement("div");
        bubble.className = "chat-bubble";

        //console.log("Processing message: " + text);

        if (window.render && typeof window.render === 'function') {
          var options = { htmlTags: true };

          const trimText = text.replace(/(\\\[)([\s\S]*?)(\\\])/g, (match, open, content, close) => {
            // ìº¡ì³í•œ content ë‚´ì˜ ê°œí–‰ë¬¸ìë¥¼ ê³µë°±ìœ¼ë¡œ ì¹˜í™˜
            const newContent = content.replace(/<br>/g, " ");
            return open + newContent + close;
          });
          
          if (typeof window.loadMathJax === "function") {
            console.log("Loading MathJax...");
            try {
              window.loadMathJax();  // ì§ì ‘ ì‹¤í–‰ í›„
              setTimeout(() => {  // 500ms í›„ ì‹¤í–‰
                console.log("MathJax Loaded. Rendering...");
                bubble.innerHTML = window.render(trimText, options);
                showTypingAnimation()
                scrollToBottom();  // âœ… ìŠ¤í¬ë¡¤ ì´ë™ ì¶”ê°€
              }, 10);
            } catch (e) {
              console.log("Error load MathJax =>"+ e);
              bubble.innerHTML = trimText;
              scrollToBottom();  // âœ… ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ ìŠ¤í¬ë¡¤ ì´ë™
            }
          } else {
            console.log("MathJax Not Found. Rendering Directly...");
            bubble.innerHTML = window.render(trimText, options);
            scrollToBottom();  // âœ… ìŠ¤í¬ë¡¤ ì´ë™ ì¶”ê°€
          }
        } else {
          console.log("window.render not found. Using plain text.");
          bubble.innerText = trimText;
          scrollToBottom();  // âœ… ìŠ¤í¬ë¡¤ ì´ë™ ì¶”ê°€
        }

        messageDiv.appendChild(bubble);
        container.appendChild(messageDiv);
        
        // âœ… ë¹„ë™ê¸°ì ìœ¼ë¡œ ìŠ¤í¬ë¡¤ ì´ë™
        setTimeout(scrollToBottom, 100);
      }

      // âœ… ì •í™•í•œ ìŠ¤í¬ë¡¤ ì´ë™ í•¨ìˆ˜ ì¶”ê°€
    function scrollToBottom() {
        var container = document.getElementById("chatMessages");
        if (container) {
            container.scrollTop = container.scrollHeight - container.clientHeight;
        }
    }
      
    function addImageMessage(imageData, type) {
      var container = document.getElementById("chatMessages");
      var messageDiv = document.createElement("div");
      messageDiv.className = "chat-message " + type;
      
      var bubble = document.createElement("div");
      bubble.className = "chat-bubble";
      
      var img = document.createElement("img");
      img.src = imageData;
      img.style.maxWidth = "90%";
      img.style.borderRadius = "10px";
      
      bubble.appendChild(img);
      messageDiv.appendChild(bubble);
      container.appendChild(messageDiv);
      
      setTimeout(scrollToBottom, 100);
    }
  </script>
</head>
<body>
  <div class="chat-container">
    <div id="chatMessages" class="chat-messages"></div>
    <!-- Lottie ì• ë‹ˆë©”ì´ì…˜ì´ í‘œì‹œë  ì˜ì—­ -->
    <div id="lottie-animation" class="lottie-container" style="width: 64px; height: 40px;"></div>
  </div>
</body>
</html>
